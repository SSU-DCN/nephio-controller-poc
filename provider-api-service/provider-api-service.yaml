
apiVersion: apps/v1 
kind: Deployment 
metadata:
  name: provider-api-service-controller
  namespace: nephio-system
  labels:
    app: provider-api-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: provider-api-service
  template:
    metadata:
      labels:
        app: provider-api-service
    spec:
      containers:
      - name: provider-api-service-deployment
        image: ntnguyencse/provider-api-service:v0.9
        imagePullPolicy: IfNotPresent
        env:
          - name: KUBECONFIG
            value: /kubeconfig/config
          - name: OPENSTACK_FAILURE_DOMAIN
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-failure-domain 
          - name: OPENSTACK_IMAGE_NAME
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-image-name 
          - name: OPENSTACK_EXTERNAL_NETWORK_ID
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-external-network-id 
          - name: OPENSTACK_NODE_MACHINE_FLAVOR
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-node-machine-flavor 
          - name: OPENSTACK_DNS_NAMESERVERS
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-dns-nameservers 
          - name: OPENSTACK_CONTROL_PLANE_MACHINE_FLAVOR
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-control-plane-machine-flavor
          - name: OPENSTACK_SSH_KEY_NAME
            valueFrom:
              configMapKeyRef:
                name: openstack-env
                key: openstack-ssh-key-name 
            
        ports:
          - containerPort: 3333
            name: pvd-svc-port
        volumeMounts:
        - name: kubeconfig
          mountPath: /kubeconfig
      volumes:
      - name: kubeconfig
        configMap: 
          name: clusterapi-management-kubeconfig
      # env:
      #   # Define the environment variable
      #   - name: SPECIAL_LEVEL_KEY
      #     valueFrom:
      #       configMapKeyRef:
      #         # The ConfigMap containing the value you want to assign to SPECIAL_LEVEL_KEY
      #         name: cluster-api-kubeconfig
      #         # Specify the key associated with the value
      #         key: special.how
---
kind: Service 
apiVersion: v1 
metadata:
  name: provider-api-svc
  namespace: nephio-system
  # PROVIDER_API_SVC_SERVICE_HOST
  # PROVIDER_API_SVC_SERVICE_HOST
spec:
  # Expose the service on a static port on each node
  # so that we can access the service from outside the cluster 
  type: NodePort

  # When the node receives a request on the static port (30163)
  # "select pods with the label 'app' set to 'echo-hostname'"
  # and forward the request to one of them
  selector:
    app: provider-api-service

  ports:
    # Three types of ports for a service
    # nodePort - a static port assigned on each the node
    # port - port exposed internally in the cluster
    # targetPort - the container port to send requests to
    - name: pvdapi-svc
      port: 3333 
      targetPort: pvd-svc-port
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: openstack-env
  namespace: nephio-system
data:
  # property-like keys; each key maps to a simple value
  openstack-failure-domain : "compute"
  openstack-image-name: "ubuntu-k8s-1.24"
  openstack-external-network-id: "faa68d67-0441-4749-895b-95ac49f85d86"
  openstack-control-plane-machine-flavor: "cluster.controller"
  openstack-dns-nameservers: "8.8.8.8"
  openstack-node-machine-flavor: "cluster.compute"
  openstack-ssh-key-name: "clusterapi"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: clusterapi-management-kubeconfig
  namespace: nephio-system
data:
  config: |
    apiVersion: v1
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0
        server: https://dcn:6443
      name: hyfast
    contexts:
    - context:
        cluster: hyfast
        user: kubernetes-admin
      name: kubernetes-admin@hyfast
    current-context: kubernetes-admin@hyfast
    kind: Config
    preferences: {}
    users:
    - name: kubernetes-admin
      user:
        client-certificate-data: LS0tLS1C
        client-key-data: LS0tLS1C